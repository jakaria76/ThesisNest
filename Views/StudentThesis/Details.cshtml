@model ThesisNest.Models.ViewModels.ThesisDetailsVm
@{
    ViewData["Title"] = "Thesis Details";
}

<div class="container mt-3">
    <!-- Success/Error Messages -->
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    <!-- Thesis Info -->
    <div class="card shadow border-0 mb-4">
        <div class="card-body">
            <h3>@Model.Thesis.Title</h3>
            <div class="text-muted">
                <strong>Department:</strong> @Model.Thesis.Department?.Name
                | <strong>Supervisor:</strong> @Model.Thesis.Supervisor?.FullName
            </div>
            <hr />
            <h5>Abstract</h5>
            <p>@Model.Thesis.Abstract</p>
        </div>
    </div>

    <div class="row g-4">
        <!-- Versions -->
        <div class="col-lg-7">
            <div class="card shadow border-0">
                <div class="card-header"><h5>Versions</h5></div>
                <div class="list-group list-group-flush">
                    @if (Model.Versions == null || !Model.Versions.Any())
                    {
                        <div class="list-group-item text-muted">No versions uploaded yet.</div>
                    }
                    else
                    {
                        @foreach (var v in Model.Versions.OrderByDescending(x => x.VersionNo))
                        {
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <div><strong>Version @v.VersionNo</strong></div>
                                    <div class="text-muted small">@v.CreatedAt.ToLocalTime().ToString("dd MMM yyyy, hh:mm tt")</div>
                                </div>
                                <div class="btn-group">
                                    <!-- Preview: PDF / DOCX -->
                                    <a asp-action="PreviewVersion" asp-route-id="@v.Id" target="_blank" class="btn btn-sm btn-outline-primary">Preview</a>

                                    <!-- Download -->
                                    <a asp-action="DownloadVersion" asp-route-id="@v.Id" class="btn btn-sm btn-outline-secondary">Download</a>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <!-- Feedback -->
        <div class="col-lg-5">
            <div class="card shadow border-0">
                <div class="card-header"><h5>Feedback</h5></div>
                <div class="list-group list-group-flush">
                    @if (Model.Feedbacks == null || !Model.Feedbacks.Any())
                    {
                        <div class="list-group-item text-muted">No feedback yet.</div>
                    }
                    else
                    {
                        @foreach (var f in Model.Feedbacks.OrderByDescending(x => x.CreatedAt))
                        {
                            <div class="list-group-item d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="small text-muted">@f.CreatedAt.ToLocalTime().ToString("dd MMM yyyy, hh:mm tt")</div>
                                    <div>@f.Message</div>
                                </div>
                                <div>
                                    @if (f.AcknowledgedAt == null)
                                    {
                                        <form asp-action="AcknowledgeFeedback" method="post">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@f.Id" />
                                            <button type="submit" class="btn btn-sm btn-outline-success">Acknowledge</button>
                                        </form>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">Acknowledged</span>
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>
