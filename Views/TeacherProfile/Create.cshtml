@model ThesisNest.Models.TeacherProfile
@{
    ViewData["Title"] = "Create Teacher Profile";
    var placeholder = "https://via.placeholder.com/240x240.png?text=User";
}
<div class="container-xxl py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h3 class="m-0">@ViewData["Title"]</h3>
        <a asp-action="Index" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back to My Profile</a>
    </div>

    <form asp-action="Create" method="post" enctype="multipart/form-data" class="card border-0 shadow-lg overflow-hidden">
        @Html.AntiForgeryToken()

        <!-- Header band -->
        <div class="px-3 px-md-4 py-3 tnp-band tnp-band-create">
            <div class="row g-3 align-items-center">
                <div class="col-12 col-md">
                    <div class="fw-semibold text-muted small mb-1">Profile completeness</div>
                    <div class="progress" role="progressbar" aria-label="Completeness">
                        <div class="progress-bar" id="tnCompleteness" style="width:0%">0%</div>
                    </div>
                </div>
                <div class="col-12 col-md-auto">
                    <span class="badge rounded-pill tn-badge"><i class="bi bi-shield-check me-1"></i> Teacher / Admin</span>
                </div>
            </div>
        </div>

        <div class="card-body p-3 p-md-4">
            <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

            <div class="row g-4">
                <!-- Preview column -->
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center">
                            <div class="position-relative d-inline-block mb-3">
                                <img id="previewImg" src="@placeholder" class="rounded-circle shadow-sm tnp-photo" alt="photo" />
                                <span class="position-absolute bottom-0 end-0 translate-middle badge rounded-circle tn-badge"
                                      style="width:38px;height:38px;display:grid;place-items:center;border:3px solid var(--bg-soft)">
                                    <i class="bi bi-camera"></i>
                                </span>
                            </div>
                            <h4 class="mb-0 fw-bold" id="previewName">@Model.FullName</h4>
                            <div class="text-muted" id="previewDesig">@Model.Designation</div>
                            <div class="text-muted small" id="previewDept">@Model.Department</div>

                            <div class="d-flex flex-column gap-2 mt-3">
                                <div class="d-flex align-items-center gap-2 justify-content-center text-muted small">
                                    <i class="bi bi-link-45deg"></i>
                                    <span>Slug: <code id="slugText" class="tn-code">(auto)</code></span>
                                </div>
                                <div class="d-flex gap-2 justify-content-center flex-wrap">
                                    <span class="badge tn-chip" id="flagEmail"><i class="bi bi-envelope me-1"></i> Email Public</span>
                                    <span class="badge tn-chip" id="flagPhone"><i class="bi bi-telephone me-1"></i> Phone Public</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer text-muted small">
                            Tip: ভালো-quality, square রেশিওর ছবি দিন (min 400×400).
                        </div>
                    </div>
                </div>

                <!-- Form column -->
                <div class="col-lg-8">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label asp-for="FullName" class="form-label">Full name <span class="text-danger">*</span></label>
                            <input asp-for="FullName" class="form-control" id="inpFullName" />
                            <span asp-validation-for="FullName" class="text-danger"></span>
                            <div class="form-text">এটা থেকেই URL slug তৈরি হবে।</div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Profile Photo</label>
                            <input type="file" name="ProfileImageFile" id="inpPhoto" class="form-control" accept="image/*" />
                            <div class="form-text">JPEG/PNG/WebP, max 2MB</div>
                            <span class="text-danger" data-valmsg-for="ProfileImage"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="Designation" class="form-label"></label>
                            <input asp-for="Designation" class="form-control" id="inpDesig" />
                        </div>
                        <div class="col-md-6">
                            <label asp-for="Department" class="form-label"></label>
                            <input asp-for="Department" class="form-control" id="inpDept" />
                        </div>

                        <div class="col-md-6">
                            <label asp-for="Email" class="form-label"></label>
                            <input asp-for="Email" class="form-control" />
                            <div class="form-text">Official email হলে ভালো।</div>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="Phone" class="form-label"></label>
                            <input asp-for="Phone" class="form-control" />
                            <div class="form-text">+880… format রাখলে সুবিধা হবে।</div>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="OfficeLocation" class="form-label"></label>
                            <input asp-for="OfficeLocation" class="form-control" />
                        </div>

                        <div class="col-12">
                            <label asp-for="Bio" class="form-label"></label>
                            <textarea asp-for="Bio" class="form-control" rows="3" id="inpBio"></textarea>
                            <div class="d-flex justify-content-between small text-muted">
                                <span>Introduce yourself in 2–3 lines.</span>
                                <span><span id="bioCount">0</span>/1000</span>
                            </div>
                        </div>

                        <div class="col-12">
                            <label asp-for="ResearchSummary" class="form-label"></label>
                            <textarea asp-for="ResearchSummary" class="form-control" rows="4" id="inpResearch"></textarea>
                            <div class="d-flex justify-content-between small text-muted">
                                <span>Focus areas, interests, labs, recent works.</span>
                                <span><span id="resCount">0</span>/1500</span>
                            </div>
                        </div>

                        <div class="col-md-6 form-check ms-2">
                            <input asp-for="IsPublicEmail" class="form-check-input" id="chkPublicEmail" />
                            <label asp-for="IsPublicEmail" class="form-check-label"></label>
                        </div>
                        <div class="col-md-6 form-check ms-2">
                            <input asp-for="IsPublicPhone" class="form-check-input" id="chkPublicPhone" />
                            <label asp-for="IsPublicPhone" class="form-check-label"></label>
                        </div>

                        <div class="col-12">
                            <div class="alert alert-info border-0 shadow-sm small m-0">
                                <i class="bi bi-info-circle me-1"></i>
                                Create করার পর আপনি যেকোনো সময় Edit করে আপডেট করতে পারবেন।
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- /row -->
        </div>

        <div class="card-footer d-flex flex-wrap gap-2 justify-content-end">
            <a asp-action="Index" class="btn btn-light">Cancel</a>
            <button class="btn btn-primary" type="submit"><i class="bi bi-check2-circle me-1"></i> Save</button>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            const toSlug = (t) => (t || "")
                .toLowerCase()
                .trim()
                .replace(/[^a-z0-9\s-_]/g, "")
                .replace(/[\s_]+/g, "-")
                .replace(/-+/g, "-")
                .replace(/^-|-$/g, "") || "(auto)";

            const full = document.getElementById('inpFullName');
            const desig = document.getElementById('inpDesig');
            const dept  = document.getElementById('inpDept');
            const bio   = document.getElementById('inpBio');
            const res   = document.getElementById('inpResearch');
            const chkE  = document.getElementById('chkPublicEmail');
            const chkP  = document.getElementById('chkPublicPhone');

            const pName = document.getElementById('previewName');
            const pDes  = document.getElementById('previewDesig');
            const pDep  = document.getElementById('previewDept');
            const slugT = document.getElementById('slugText');
            const flagE = document.getElementById('flagEmail');
            const flagP = document.getElementById('flagPhone');
            const bioC  = document.getElementById('bioCount');
            const resC  = document.getElementById('resCount');
            const bar   = document.getElementById('tnCompleteness');

            function updatePreview() {
                pName.textContent = full.value || "Your Name";
                pDes.textContent  = desig.value || "";
                pDep.textContent  = dept.value || "";
                slugT.textContent = toSlug(full.value);
                flagE.classList.toggle('tn-chip-on', chkE.checked);
                flagP.classList.toggle('tn-chip-on', chkP.checked);
                bioC.textContent = bio.value.length;
                resC.textContent = res.value.length;

                // completeness heuristic
                let score = 0, total = 7;
                if (full.value) score++;
                if (desig.value) score++;
                if (dept.value) score++;
                if (bio.value.length > 30) score++;
                if (res.value.length > 60) score++;
                if (chkE.checked) score++;
                if (chkP.checked) score++;
                const pct = Math.round((score / total) * 100);
                bar.style.width = pct + "%";
                bar.textContent = pct + "%";
            }

            ['input', 'change'].forEach(evt => {
                full.addEventListener(evt, updatePreview);
                desig.addEventListener(evt, updatePreview);
                dept.addEventListener(evt, updatePreview);
                bio.addEventListener(evt, updatePreview);
                res.addEventListener(evt, updatePreview);
                chkE.addEventListener(evt, updatePreview);
                chkP.addEventListener(evt, updatePreview);
            });

            document.getElementById('inpPhoto')?.addEventListener('change', function (e) {
                const f = e.target.files?.[0];
                if (!f) return;
                if (f.size > 2 * 1024 * 1024) {
                    alert("Max 2MB image allowed.");
                    e.target.value = "";
                    return;
                }
                const url = URL.createObjectURL(f);
                document.getElementById('previewImg').src = url;
            });

            updatePreview();
        })();
    </script>
}
